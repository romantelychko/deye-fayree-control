# Система автоматичного керування зарядкою Feyree EV

Автоматичне керування зарядкою електроавто на основі стану батареї та імпорту з мережі інвертора Deye SUN-10K.

## Зміст

- [Опис](#опис)
- [Вимоги](#вимоги)
- [Швидкий старт](#швидкий-старт)
- [Налаштування](#налаштування)
  - [Отримання Device ID та Local Key](#1-отримання-device-id-та-local-key-для-feyree)
  - [Налаштування .env файлу](#2-налаштування-env-файлу)
- [Запуск](#запуск)
  - [Через Makefile](#варіант-1-через-makefile-рекомендовано)
  - [Через Docker Compose](#варіант-2-через-docker-compose)
- [Моніторинг](#моніторинг)
- [Структура проекту](#структура-проекту)
- [Усунення проблем](#усунення-проблем)
- [Ліцензія](#ліцензія)

## Опис

Система автоматично вмикає/вимикає зарядку електроавто Feyree на основі:
- **Рівня заряду батареї** інвертора (SOC ≥ 90% за замовчуванням)
- **Відсутності помітного імпорту з мережі** (< 250W за замовчуванням)

## Вимоги

- **Docker** та **Docker Compose**
- **Make** (опціонально, для зручності)
- **Deye SUN-10K** інвертор з Data Logger (підключений до локальної мережі)
- **Feyree EV** зарядка з підтримкою Tuya (підключена до локальної мережі)
- Обидва пристрої мають бути в одній локальній мережі з сервером

## Швидкий старт

```bash
# 1. Отримати Device ID та Local Key для Feyree (детально в TUYA_SETUP.md)
python3 -m venv /tmp/tuya-setup && source /tmp/tuya-setup/bin/activate
pip install tinytuya
python -m tinytuya wizard
deactivate

# 2. Створити .env файл
cp .env.example .env
nano .env  # Налаштувати LOGGER_IP, LOGGER_SN, FEYREE_*

# 3. Запустити
make build
make up
make logs
```

### Логіка роботи

**Зарядка УВІМКНЕНА (16A):**
- Батарея заряджена ≥ `SOC_THRESHOLD` (за замовчуванням 90%)
- **ТА** немає помітного імпорту з мережі:
  - Напрямок потоку != "import" (експорт або баланс)
  - **АБО** імпорт < `GRID_IMPORT_THRESHOLD` (за замовчуванням 250W)

**Зарядка ВИМКНЕНА:**
- В усіх інших випадках

## Налаштування

### 1. Отримання Device ID та Local Key для Feyree

Детальна інструкція в [TUYA_SETUP.md](TUYA_SETUP.md).

### 2. Налаштування .env файлу

Скопіюйте `.env.example` в `.env` та налаштуйте параметри:

```bash
cp .env.example .env
nano .env  # або vim, gedit, тощо
```

#### Обов'язкові параметри

**Deye інвертор:**
```env
LOGGER_IP=172.16.32.50          # IP адреса Data Logger
LOGGER_SN=0000000000            # Серійний номер (10 цифр)
```

**Feyree зарядка:**
```env
FEYREE_IP=172.16.32.48                  # IP адреса зарядки
FEYREE_DEVICE_ID=000000000000000000    # Device ID з Tuya (через tinytuya wizard)
FEYREE_LOCAL_KEY=00000000000000        # Local Key з Tuya (через tinytuya wizard)
```

#### Додаткові параметри (опціонально)

**Логіка керування:**
```env
SOC_THRESHOLD=90                  # Мінімальний SOC для зарядки (%)
GRID_IMPORT_THRESHOLD=250         # Максимальний імпорт з мережі (W)
CHECK_INTERVAL_SEC=120            # Інтервал перевірки (секунди)
CHARGING_CURRENT_A=16             # Сила струму зарядки (A)
```

**Налаштування підключення:**
```env
FEYREE_VERSION=3.3                # Версія протоколу Tuya (3.1, 3.3, 3.4)
MB_SLAVE_ID=1                     # Modbus Slave ID
LOGGER_PORT=8899                  # Порт Data Logger
CONNECTION_TIMEOUT_SEC=15         # Таймаут підключення
MAX_ATTEMPTS=5                    # Максимум спроб підключення
RETRY_DELAY_SEC=1.0               # Затримка між спробами
```

**DPS коди Feyree (якщо відрізняються):**
```env
FEYREE_SWITCH_DPS=18              # DPS код перемикача
FEYREE_MODE_DPS=14                # DPS код режиму роботи
FEYREE_CHARGE_NOW_MODE=charge_now # Значення режиму зарядки
```

## Запуск

### Варіант 1: Через Makefile (рекомендовано)

```bash
# Переглянути всі доступні команди
make help

# Збудувати Docker образ
make build

# Запустити в фоновому режимі
make up

# Переглянути логи в реальному часі
make logs

# Перезапустити контейнер
make restart

# Зупинити контейнер
make down

# Видалити контейнер та образи
make clean

# Запустити в тестовому режимі (foreground)
make test
```

### Варіант 2: Через Docker Compose

```bash
# Запуск в фоновому режимі
docker compose up -d

# Перегляд логів
docker compose logs -f

# Зупинка
docker compose down
```

## Моніторинг

Приклад виводу:

```
2025-11-18 19:10:13,450 - INFO - ============================================================
2025-11-18 19:10:13,450 - INFO - Запуск системи керування зарядкою Feyree EV
2025-11-18 19:10:13,450 - INFO - ============================================================
2025-11-18 19:10:13,450 - INFO - Порогові значення:
2025-11-18 19:10:13,450 - INFO -   - Мінімальний SOC для зарядки: 90.0%
2025-11-18 19:10:13,451 - INFO -   - Максимальний імпорт з мережі: 250.0W
2025-11-18 19:10:13,451 - INFO -   - Інтервал перевірки: 120 сек
2025-11-18 19:10:13,451 - INFO -   - Сила струму зарядки: 16A
2025-11-18 19:10:13,451 - INFO - ============================================================
2025-11-18 19:10:14,482 - INFO - Deye інвертор: підключення до 172.16.32.50:8899 (SN: 00000000)
2025-11-18 19:10:14,482 - INFO - Feyree зарядка: підключення до 172.16.32.48 (ID: 00000000000000000000)
2025-11-18 19:10:14,482 - INFO - ------------------------------------------------------------
2025-11-18 19:10:14,482 - INFO - Перевірка підключення до пристроїв...
2025-11-18 19:10:14,482 - INFO - ------------------------------------------------------------
2025-11-18 19:10:14,482 - INFO - Тестове підключення до Deye інвертора...
2025-11-18 19:10:14,601 - INFO - Deye інвертор: Підключення УСПІШНЕ
2025-11-18 19:10:14,601 - INFO -   Поточний SOC: 90.0%
2025-11-18 19:10:14,601 - INFO -   Потужність мережі: 64W (import)
2025-11-18 19:10:14,601 - INFO - Тестове підключення до Feyree зарядки...
2025-11-18 19:10:14,622 - INFO - Feyree зарядка: Підключення УСПІШНЕ
2025-11-18 19:10:14,622 - INFO -   Стан: ВВІМК
2025-11-18 19:10:14,622 - INFO -   Режим: charge_now
2025-11-18 19:10:14,622 - INFO - Всі пристрої підключені успішно. Запуск основного циклу...
2025-11-18 19:10:14,622 - INFO - ------------------------------------------------------------
2025-11-18 19:10:14,622 - INFO - Ітерація #1 - 2025-11-18 19:10:14
2025-11-18 19:10:14,622 - INFO - Читання даних з Deye інвертора...
2025-11-18 19:10:15,097 - INFO - Стан системи:
2025-11-18 19:10:15,097 - INFO -   - Батарея: 90.0%
2025-11-18 19:10:15,097 - INFO -   - Мережа: 64W (import)
2025-11-18 19:10:15,097 - INFO - Аналіз умов зарядки:
2025-11-18 19:10:15,097 - INFO -   - SOC >= 90.0%: ТАК
2025-11-18 19:10:15,097 - INFO -   - Імпорт < 250.0W або експорт: ТАК
2025-11-18 19:10:15,097 - INFO - Рішення: УВІМКНУТИ зарядку
2025-11-18 19:10:15,097 - INFO - Отримання стану пристрою...
2025-11-18 19:10:15,112 - INFO - [ДО] Стан пристрою Feyree:
2025-11-18 19:10:15,112 - INFO -   └─ DPS 18 (switch): ВВІМК
2025-11-18 19:10:15,112 - INFO -   └─ DPS 14 (work_mode): charge_now
2025-11-18 19:10:15,112 - INFO -   └─ DPS 101 (charge_status): charing
2025-11-18 19:10:15,112 - INFO -   └─ DPS 124 (mode_status): CloseCharging
2025-11-18 19:10:15,112 - INFO -   └─ DPS 114 (current): 16A
2025-11-18 19:10:15,112 - INFO -   └─ DPS 115 (max_current): 16A
2025-11-18 19:10:15,112 - INFO -   └─ DPS 102 (energy): 2.197 kWh
2025-11-18 19:10:15,112 - INFO -   └─ DPS 120 (time): 00:06:36
2025-11-18 19:10:15,112 - INFO - Зарядка ЗАКРИТА (DPS 124 = CloseCharging), спроба ВІДКРИТИ...
2025-11-18 19:10:15,112 - INFO - Спроба увімкнути зарядку Feyree на 16A
2025-11-18 19:10:16,912 - INFO - Зарядка Feyree УВІМКНЕНА (16A)
2025-11-18 19:10:18,912 - INFO - Перевірка стану після виконання команди...
2025-11-18 19:10:18,926 - INFO - [ПІСЛЯ] Стан пристрою Feyree:
2025-11-18 19:10:18,926 - INFO -   └─ DPS 18 (switch): ВВІМК
2025-11-18 19:10:18,926 - INFO -   └─ DPS 14 (work_mode): charge_now
2025-11-18 19:10:18,926 - INFO -   └─ DPS 101 (charge_status): charing
2025-11-18 19:10:18,926 - INFO -   └─ DPS 124 (mode_status): CloseCharging
2025-11-18 19:10:18,927 - INFO -   └─ DPS 114 (current): 16A
2025-11-18 19:10:18,927 - INFO -   └─ DPS 115 (max_current): 16A
2025-11-18 19:10:18,927 - INFO -   └─ DPS 102 (energy): 2.193 kWh
2025-11-18 19:10:18,927 - INFO -   └─ DPS 120 (time): 00:06:40
2025-11-18 19:10:18,927 - INFO - Очікування 120 секунд до наступної перевірки...
```

## Структура проекту

```
.
├── main.py              # Основний скрипт
├── requirements.txt     # Python залежності
├── Dockerfile           # Docker образ
├── docker-compose.yml   # Docker Compose конфігурація
├── Makefile             # Команди для управління
├── .env                 # Конфігурація (не в git, створюється користувачем)
├── .env.example         # Шаблон конфігурації
├── README.md            # Ця документація
├── TUYA_SETUP.md        # Інструкція налаштування Tuya
└── LICENSE              # Ліцензія MIT
```

## Усунення проблем

### Помилка підключення до Deye інвертора

```
ERROR - Deye інвертор: Підключення НЕВДАЛЕ
```

**Рішення:**
- Перевірте IP адресу Data Logger: `ping <LOGGER_IP>`
- Перевірте що серійний номер правильний (10 цифр)
- Перевірте що порт 8899 відкритий
- Переконайтесь що Data Logger в тій самій мережі

### Помилка підключення до Feyree зарядки

```
ERROR - Feyree зарядка: Підключення НЕВДАЛЕ
```

**Рішення:**
- Перевірте IP адресу зарядки: `ping <FEYREE_IP>`
- Перевірте DEVICE_ID та LOCAL_KEY (отримані через `tinytuya wizard`)
- Спробуйте іншу версію протоколу: `FEYREE_VERSION=3.1` або `3.4`
- Перевірте що зарядка підключена до WiFi
- Детальніше в [TUYA_SETUP.md](TUYA_SETUP.md#усунення-проблем)

### Зарядка не вмикається автоматично

**Перевірте умови в логах:**
- `SOC >= 90%` - батарея достатньо заряджена?
- `Імпорт < 250W` - чи достатньо сонячної генерації?

**Налаштуйте пороги в `.env`:**
```env
SOC_THRESHOLD=85              # Зменшити поріг SOC
GRID_IMPORT_THRESHOLD=500     # Збільшити дозволений імпорт
```

### Зарядка часто вмикається/вимикається

**Рішення:**
- Збільште інтервал перевірки: `CHECK_INTERVAL_SEC=300` (5 хвилин)
- Збільште дозволений імпорт: `GRID_IMPORT_THRESHOLD=500`

### Перегляд детальних логів

```bash
# В реальному часі
make logs

# Останні 100 рядків
docker compose logs --tail=100

# Всі логи з певного часу
docker compose logs --since 1h
```

## Ліцензія

MIT License

---

**Важливо:** Це програмне забезпечення керує процесом зарядки електроавто. Переконайтесь що всі налаштування правильні перед використанням. Автор не несе відповідальності за можливі пошкодження обладнання.
