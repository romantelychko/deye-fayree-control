# Система автоматичного керування зарядкою Feyree EV

Автоматичне керування зарядкою електроавто на основі стану батареї та імпорту з мережі інвертора Deye SUN-10K.

## Опис

Система автоматично вмикає/вимикає зарядку електроавто Feyree на основі:
- **Рівня заряду батареї** інвертора (SOC ≥ 90% за замовчуванням)
- **Відсутності помітного імпорту з мережі** (< 250W за замовчуванням)

### Логіка роботи

**Зарядка УВІМКНЕНА (16A):**
- Батарея заряджена ≥ `SOC_THRESHOLD` (за замовчуванням 90%)
- **ТА** немає помітного імпорту з мережі:
  - Напрямок потоку != "import" (експорт або баланс)
  - **АБО** імпорт < `GRID_IMPORT_THRESHOLD` (за замовчуванням 250W)

**Зарядка ВИМКНЕНА:**
- В усіх інших випадках

## Налаштування

### 1. Отримання Device ID та Local Key для Feyree

Детальна інструкція в [TUYA_SETUP.md](TUYA_SETUP.md).

### 2. Налаштування .env файлу

Скопіюйте `.env.example` в `.env` та налаштуйте параметри:

```bash
cp .env.example .env
gedit .env
```

**Обов'язкові параметри для зміни:**
```env
LOGGER_IP=172.16.32.50
LOGGER_SN=0000000000

FEYREE_IP=172.16.32.48
FEYREE_DEVICE_ID=000000000000000000
FEYREE_LOCAL_KEY=00000000000000
```

## Запуск

Запуск через Docker Compose:

```bash
docker compose up -d
```

Перегляд логів:

```bash
docker compose logs -f
```

## Моніторинг

Перегляд логів в реальному часі:

```bash
docker compose logs -f
```

Приклад виводу:

```
2025-11-18 11:56:47,746 - INFO - ============================================================
2025-11-18 11:56:47,746 - INFO - Запуск системи керування зарядкою Feyree EV
2025-11-18 11:56:47,746 - INFO - ============================================================
2025-11-18 11:56:47,747 - INFO - Порогові значення:
2025-11-18 11:56:47,747 - INFO -   - Мінімальний SOC для зарядки: 90.0%
2025-11-18 11:56:47,747 - INFO -   - Максимальний імпорт з мережі: 250.0W
2025-11-18 11:56:47,747 - INFO -   - Інтервал перевірки: 120 сек
2025-11-18 11:56:47,747 - INFO -   - Сила струму зарядки: 16A
2025-11-18 11:56:47,747 - INFO - ============================================================
2025-11-18 11:56:47,770 - INFO - Deye інвертор: підключення до 172.16.32.50:8899 (SN: 0000000000)
2025-11-18 11:56:47,770 - INFO - Feyree зарядка: підключення до 172.16.32.48 (ID: 0000000000000000000000)
2025-11-18 11:56:47,770 - INFO - ------------------------------------------------------------
2025-11-18 11:56:47,770 - INFO - Ітерація #1 - 2025-11-18 11:56:47
2025-11-18 11:56:47,770 - INFO - Читання даних з Deye інвертора...
2025-11-18 11:56:47,886 - INFO - Стан системи:
2025-11-18 11:56:47,886 - INFO -   - Батарея: 90.0%
2025-11-18 11:56:47,886 - INFO -   - Мережа: 15W (import)
2025-11-18 11:56:47,886 - INFO - Аналіз умов зарядки:
2025-11-18 11:56:47,886 - INFO -   - SOC >= 90.0%: ✓
2025-11-18 11:56:47,886 - INFO -   - Імпорт < 250.0W або експорт: ✓
2025-11-18 11:56:47,886 - INFO - Рішення: УВІМКНУТИ зарядку
2025-11-18 11:56:47,886 - INFO - Спроба увімкнути зарядку Feyree на 16A
2025-11-18 11:56:50,463 - INFO - ✓ Зарядка Feyree УВІМКНЕНА (16A)
2025-11-18 11:56:50,463 - INFO - Очікування 120 секунд до наступної перевірки...
2025-11-18 11:58:50,463 - INFO - ------------------------------------------------------------
2025-11-18 11:58:50,463 - INFO - Ітерація #2 - 2025-11-18 11:58:50
2025-11-18 11:58:50,463 - INFO - Читання даних з Deye інвертора...
2025-11-18 11:58:50,581 - INFO - Стан системи:
2025-11-18 11:58:50,581 - INFO -   - Батарея: 90.0%
2025-11-18 11:58:50,581 - INFO -   - Мережа: 11W (import)
2025-11-18 11:58:50,581 - INFO - Аналіз умов зарядки:
2025-11-18 11:58:50,581 - INFO -   - SOC >= 90.0%: ✓
2025-11-18 11:58:50,581 - INFO -   - Імпорт < 250.0W або експорт: ✓
2025-11-18 11:58:50,581 - INFO - Рішення: УВІМКНУТИ зарядку
2025-11-18 11:58:50,581 - INFO - Стан зарядки не змінився (залишається: ВКЛ)
2025-11-18 11:58:50,581 - INFO - Очікування 120 секунд до наступної перевірки...
```

## Структура проекту

```
.
├── main.py              # Основний скрипт
├── requirements.txt     # Python залежності
├── Dockerfile          # Docker образ
├── .env                # Конфігурація (не в git)
├── .env.example        # Шаблон конфігурації
└── README.md           # Ця документація
```

## Ліцензія

MIT License

---

**Важливо:** Це програмне забезпечення керує процесом зарядки електроавто. Переконайтесь що всі налаштування правильні перед використанням. Автор не несе відповідальності за можливі пошкодження обладнання.
