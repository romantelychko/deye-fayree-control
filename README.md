# Система автоматичного керування зарядкою Feyree EV

Автоматичне керування зарядкою електроавто на основі стану батареї та імпорту з мережі інвертора Deye SUN-10K.

## Опис

Система автоматично вмикає/вимикає зарядку електроавто Feyree на основі:
- **Рівня заряду батареї** інвертора (SOC ≥ 90% за замовчуванням)
- **Відсутності помітного імпорту з мережі** (< 250W за замовчуванням)

### Логіка роботи

**Зарядка УВІМКНЕНА (16A):**
- Батарея заряджена ≥ `SOC_THRESHOLD` (за замовчуванням 90%)
- **ТА** немає помітного імпорту з мережі:
  - Напрямок потоку != "import" (експорт або баланс)
  - **АБО** імпорт < `GRID_IMPORT_THRESHOLD` (за замовчуванням 250W)

**Зарядка ВИМКНЕНА:**
- В усіх інших випадках

## Налаштування

### 1. Отримання Device ID та Local Key для Feyree

Детальна інструкція в [TUYA_SETUP.md](TUYA_SETUP.md).

### 2. Налаштування .env файлу

Скопіюйте `.env.example` в `.env` та налаштуйте параметри:

```bash
cp .env.example .env
gedit .env
```

**Обов'язкові параметри для зміни:**
```env
LOGGER_IP=172.16.32.50
LOGGER_SN=0000000000

FEYREE_IP=172.16.32.48
FEYREE_DEVICE_ID=000000000000000000
FEYREE_LOCAL_KEY=00000000000000
```

## Запуск

Запуск через Docker Compose:

```bash
docker compose up -d
```

Перегляд логів:

```bash
docker compose logs -f
```

## Моніторинг

Перегляд логів в реальному часі:

```bash
docker compose logs -f
```

Приклад виводу:

```
2025-11-18 19:10:13,450 - INFO - ============================================================
2025-11-18 19:10:13,450 - INFO - Запуск системи керування зарядкою Feyree EV
2025-11-18 19:10:13,450 - INFO - ============================================================
2025-11-18 19:10:13,450 - INFO - Порогові значення:
2025-11-18 19:10:13,450 - INFO -   - Мінімальний SOC для зарядки: 90.0%
2025-11-18 19:10:13,451 - INFO -   - Максимальний імпорт з мережі: 250.0W
2025-11-18 19:10:13,451 - INFO -   - Інтервал перевірки: 120 сек
2025-11-18 19:10:13,451 - INFO -   - Сила струму зарядки: 16A
2025-11-18 19:10:13,451 - INFO - ============================================================
2025-11-18 19:10:14,482 - INFO - Deye інвертор: підключення до 172.16.32.50:8899 (SN: 00000000)
2025-11-18 19:10:14,482 - INFO - Feyree зарядка: підключення до 172.16.32.48 (ID: 00000000000000000000)
2025-11-18 19:10:14,482 - INFO - ------------------------------------------------------------
2025-11-18 19:10:14,482 - INFO - Перевірка підключення до пристроїв...
2025-11-18 19:10:14,482 - INFO - ------------------------------------------------------------
2025-11-18 19:10:14,482 - INFO - Тестове підключення до Deye інвертора...
2025-11-18 19:10:14,601 - INFO - Deye інвертор: Підключення УСПІШНЕ
2025-11-18 19:10:14,601 - INFO -   Поточний SOC: 90.0%
2025-11-18 19:10:14,601 - INFO -   Потужність мережі: 64W (import)
2025-11-18 19:10:14,601 - INFO - Тестове підключення до Feyree зарядки...
2025-11-18 19:10:14,622 - INFO - Feyree зарядка: Підключення УСПІШНЕ
2025-11-18 19:10:14,622 - INFO -   Стан: ВВІМК
2025-11-18 19:10:14,622 - INFO -   Режим: charge_now
2025-11-18 19:10:14,622 - INFO - Всі пристрої підключені успішно. Запуск основного циклу...
2025-11-18 19:10:14,622 - INFO - ------------------------------------------------------------
2025-11-18 19:10:14,622 - INFO - Ітерація #1 - 2025-11-18 19:10:14
2025-11-18 19:10:14,622 - INFO - Читання даних з Deye інвертора...
2025-11-18 19:10:15,097 - INFO - Стан системи:
2025-11-18 19:10:15,097 - INFO -   - Батарея: 90.0%
2025-11-18 19:10:15,097 - INFO -   - Мережа: 64W (import)
2025-11-18 19:10:15,097 - INFO - Аналіз умов зарядки:
2025-11-18 19:10:15,097 - INFO -   - SOC >= 90.0%: ТАК
2025-11-18 19:10:15,097 - INFO -   - Імпорт < 250.0W або експорт: ТАК
2025-11-18 19:10:15,097 - INFO - Рішення: УВІМКНУТИ зарядку
2025-11-18 19:10:15,097 - INFO - Отримання стану пристрою...
2025-11-18 19:10:15,112 - INFO - [ДО] Стан пристрою Feyree:
2025-11-18 19:10:15,112 - INFO -   └─ DPS 18 (switch): ВВІМК
2025-11-18 19:10:15,112 - INFO -   └─ DPS 14 (work_mode): charge_now
2025-11-18 19:10:15,112 - INFO -   └─ DPS 101 (charge_status): charing
2025-11-18 19:10:15,112 - INFO -   └─ DPS 124 (mode_status): CloseCharging
2025-11-18 19:10:15,112 - INFO -   └─ DPS 114 (current): 16A
2025-11-18 19:10:15,112 - INFO -   └─ DPS 115 (max_current): 16A
2025-11-18 19:10:15,112 - INFO -   └─ DPS 102 (energy): 2.197 kWh
2025-11-18 19:10:15,112 - INFO -   └─ DPS 120 (time): 00:06:36
2025-11-18 19:10:15,112 - INFO - Зарядка ЗАКРИТА (DPS 124 = CloseCharging), спроба ВІДКРИТИ...
2025-11-18 19:10:15,112 - INFO - Спроба увімкнути зарядку Feyree на 16A
2025-11-18 19:10:16,912 - INFO - Зарядка Feyree УВІМКНЕНА (16A)
2025-11-18 19:10:18,912 - INFO - Перевірка стану після виконання команди...
2025-11-18 19:10:18,926 - INFO - [ПІСЛЯ] Стан пристрою Feyree:
2025-11-18 19:10:18,926 - INFO -   └─ DPS 18 (switch): ВВІМК
2025-11-18 19:10:18,926 - INFO -   └─ DPS 14 (work_mode): charge_now
2025-11-18 19:10:18,926 - INFO -   └─ DPS 101 (charge_status): charing
2025-11-18 19:10:18,926 - INFO -   └─ DPS 124 (mode_status): CloseCharging
2025-11-18 19:10:18,927 - INFO -   └─ DPS 114 (current): 16A
2025-11-18 19:10:18,927 - INFO -   └─ DPS 115 (max_current): 16A
2025-11-18 19:10:18,927 - INFO -   └─ DPS 102 (energy): 2.193 kWh
2025-11-18 19:10:18,927 - INFO -   └─ DPS 120 (time): 00:06:40
2025-11-18 19:10:18,927 - INFO - Очікування 120 секунд до наступної перевірки...
```

## Структура проекту

```
.
├── main.py              # Основний скрипт
├── requirements.txt     # Python залежності
├── Dockerfile          # Docker образ
├── .env                # Конфігурація (не в git)
├── .env.example        # Шаблон конфігурації
└── README.md           # Ця документація
```

## Ліцензія

MIT License

---

**Важливо:** Це програмне забезпечення керує процесом зарядки електроавто. Переконайтесь що всі налаштування правильні перед використанням. Автор не несе відповідальності за можливі пошкодження обладнання.
